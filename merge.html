<!DOCTYPE radio chart >
<html >
<body>

<noscript><div id="noscript">You need JavaScript enabled to view most of the demos!</div></noscript>
    <div id = "Dropdown"></div>

<tr>
    <div id="chart"></div>
</tr>
<tr>
    <div id="yearaxis"></div>
</tr>
</body>

<script src="http://d3js.org/d3.v4.min.js"></script>

<script type="text/javascript">


    var parseTime = d3.timeParse("%Y");

    var d = [
              [
               {axis: "strength", value: 13},
               {axis: "intelligence", value: 1},
               {axis: "charisma", value: 8},
               {axis: "dexterity", value: 4},
               {axis: "luck", value: 9}
              ],[
               {axis: "strength", value: 3},
               {axis: "intelligence", value: 15},
               {axis: "charisma", value: 4},
               {axis: "dexterity", value: 1},
               {axis: "luck", value: 15}
              ],[
               {axis: "strength", value: 5},
               {axis: "intelligence", value: 1},
               {axis: "charisma", value: 16},
               {axis: "dexterity", value: 10},
               {axis: "luck", value: 5}
              ]
            ];


    var sales_data;
    var genres = [];
    var genrenested_data = [];
    var yearnested_data = [];

    // load data
    var q = d3.queue()
        q.defer(d3.csv, 'vgsales.csv')
        q.await(ready)

    function ready(error, data) {
        if(error)
            console.log(error)

        console.log(data)

        sales_data = data

        sales_data = sales_data.filter(function(d){
                      return d.Year != 'N/A';
                  })

        sales_data.forEach(function(d){
//                      d.Year = parseTime(d.Year.toString());
                      d.Global_Sales = d.Global_Sales - 0;
                  })

        console.log(sales_data)

        // collect all the genres
        genrenested_data = d3.nest()
                    .key(function(d){return d['Genre']})
                    .sortKeys(d3.ascending)
                    .entries(sales_data)

        for ( var i=0; i<genrenested_data.length; i++ ) {
            var item = {
                axis: genrenested_data[i].key,
                value: 0}
            genres.push(item);
        }

        yearnested_data = d3.nest()
                    .key(function(d){return d['Year']})
                    .sortKeys(d3.ascending)
                    .rollup(function(d) { return {
                        recorder: d,
                        total: 0,
                        total: d3.sum(d, function(d) { return d.Global_Sales; }),
                        }; })
                    .key(function(d){return d['Genre']})
                    .sortKeys(d3.ascending)
                    .entries(sales_data)

        console.log(yearnested_data)

        var minYear = yearnested_data[0].key;
        var maxYear = yearnested_data[yearnested_data.length - 1].key;

        console.log(minYear)
        console.log(maxYear)




        var g = d3.select(yearaxis).append("svgaxis").attr("width", 650).attr("height", 20).append("g");

        g.append("line")
            .attr("x1", 10)
            .attr("y1", 10)
            .attr("x2", 610)
            .attr("y2", 10)
            .attr("class", "line").style("stroke", "grey").style("stroke-width", "1px");



        var select = d3.select("#Dropdown").append("select")

        select.selectAll("option")
              .data(yearnested_data)
              .enter()
              .append("option")
                  .attr("value", function (d) { return d.key; })
                  .text(function (d) { return d.key; });

        select.on("change", function(d) {
            var value = d3.select(this).property("value");
            var index = d3.select(this).property("index");

            drawChart(value);
        });

}











    function drawChart(year) {
        var dd = [];
        var ddd = [];
        var year;

//        for ( var i=0; i<sales_data.length; i++ ) {
//            if (sales_data[i].Year.getFullYear() == 1991) {
//                var item = {
//                    rank: sales_data[i].Rank,
//                    axis: sales_data[i].Genre,
//                    value: sales_data[i].Global_Sales
//                }
//                dd.push(item)
//            }
//        }

        for (var i=0; i<yearnested_data.length; i++ ) {
            var y  = parseTime(yearnested_data[i].key);
            var yy = parseTime(year);

            var y1  = y.getFullYear() - 0;
            var yy1 = yy.getFullYear() - 0;
            if (y1 == yy1) {

            var item = []

                var yearsales = yearnested_data[i].values;
                for (var j=0; j<genres.length; j++) {
                    item = {
                        axis: genres[j].axis,
                        value: 0
                    }

                    for (var k=0; k<yearsales.length; k++)
                        if (genres[j].axis == yearsales[k].key) {
                            item.value = yearsales[k].value.total;
                        }
                    dd.push(item)
                }
                break;
            }
        }

        ddd.push(dd)

        console.log(dd)
        console.log(dd.length)
        console.log(ddd)

        drawRadarChart("#chart", ddd);

}



    function drawRadarChart (id, d, options) {
        var cfg = {
            radius: 5,
            w: 600,
            h: 600,
            factor: .95,
            factorLegend: 1,
            levels: 3,
            maxValue: 0,
            radians: 2 * Math.PI,
            opacityArea: 0.5,
            color: d3.scaleOrdinal(d3.schemeCategory10),
            fontSize: 10
        };

        if ('undefined' !== typeof options) {
            for (var i in options){
                if ('undefined' !== typeof options[i]){
                    cfg[i] = options[i];
                }
            }
        }

        cfg.maxValue = Math.max(cfg.maxValue, d3.max(d, function(i){return d3.max(i.map(function(o){return o.value;}))}));
        var allAxis = (d[0].map(function(i, j){return i.axis}));
        var total = allAxis.length;
        var radius = cfg.factor * Math.min(cfg.w/2, cfg.h/2);
        d3.select(id).select("svg").remove();
        var g = d3.select(id).append("svg").attr("width", cfg.w).attr("height", cfg.h).append("g");

        var tooltip;
        function getPosition(i, range, factor, func){
            factor = typeof factor !== 'undefined' ? factor : 1;
            return range * (1 - factor * func(i * cfg.radians / total));
        }

        function getHorizontalPosition(i, range, factor){
            return getPosition(i, range, factor, Math.sin);
        }

        function getVerticalPosition(i, range, factor){
            return getPosition(i, range, factor, Math.cos);
        }

        // draw the circles
        for (var j=0; j<cfg.levels; j++){
            var levelFactor = radius*((j+1)/cfg.levels);
            g.selectAll(".levels").data(allAxis).enter().append("svg:line")
                                  .attr("x1", function(d, i){return getHorizontalPosition(i, levelFactor);})
                                  .attr("y1", function(d, i){return getVerticalPosition(i, levelFactor);})
                                  .attr("x2", function(d, i){return getHorizontalPosition(i+1, levelFactor);})
                                  .attr("y2", function(d, i){return getVerticalPosition(i+1, levelFactor);})
                                  .attr("class", "line")
                                      .style("stroke", "grey")
                                      .style("stroke-width", "0.5px")
                                      .attr("transform", "translate(" + (cfg.w/2-levelFactor) + ", " + (cfg.h/2-levelFactor) + ")");
        }

        series = 0;

        // draw the axises
        var axis = g.selectAll(".axis").data(allAxis).enter().append("g").attr("class", "axis");

        axis.append("line")
            .attr("x1", cfg.w/2)
            .attr("y1", cfg.h/2)
            .attr("x2", function(j, i){return getHorizontalPosition(i, cfg.w/2, cfg.factor);})
            .attr("y2", function(j, i){return getVerticalPosition(i, cfg.h/2, cfg.factor);})
            .attr("class", "line").style("stroke", "grey").style("stroke-width", "1px");

        // add legend of axis
        axis.append("text").attr("class", "legend")
            .text(function(d){return d})
            .style("font-family", "sans-serif").style("font-size", cfg.fontSize + "px")
            .style("text-anchor", function(d, i){
                var p = getHorizontalPosition(i, 0.5);
                return (p < 0.4) ? "start" : ((p > 0.6) ? "end" : "middle");})
            .attr("transform", function(d, i){
                var p = getVerticalPosition(i, cfg.h / 2);
                return p < cfg.fontSize ? "translate(0, " + (cfg.fontSize - p) + ")" : "";})
            .attr("x", function(d, i){return getHorizontalPosition(i, cfg.w / 2, cfg.factorLegend);})
            .attr("y", function(d, i){return getVerticalPosition(i, cfg.h / 2, cfg.factorLegend);});


        // draw the polygon
        d.forEach(function(y, x){
            dataValues = [];
            g.selectAll(".nodes")
                .data(y, function(j, i){
                    if (j.value != 0)
                        dataValues.push([getHorizontalPosition(i, cfg.w/2, (parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor),
                                         getVerticalPosition(i, cfg.h/2, (parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor)
                                        ]);
                  });

            dataValues.push(dataValues[0]);
            g.selectAll(".area")
             .data([dataValues])
             .enter()
             .append("polygon")
             .attr("class", "radar-chart-serie"+series)
             .style("stroke-width", "2px")
             .style("stroke", cfg.color(series))
             .attr("points",function(d) {
                 var str="";
                 for(var pti=0;pti<d.length;pti++){
                     str=str+d[pti][0]+","+d[pti][1]+" ";
                 }
                 return str;
              })
             .style("fill", function(j, i){return cfg.color(series)})
             .style("fill-opacity", cfg.opacityArea)
             .on('mouseover', function (d){
                 z = "polygon."+d3.select(this).attr("class");
                 g.selectAll("polygon").transition(200).style("fill-opacity", 0.1);
                 g.selectAll(z).transition(200).style("fill-opacity", .7);
                 })
             .on('mouseout', function(){
                 g.selectAll("polygon").transition(200).style("fill-opacity", cfg.opacityArea);
                 });
            series++;
        });

        series = 0;

        // draw all tne nodes
        d.forEach(function(y, x){
            g.selectAll(".nodes")
             .data(y).enter()
             .append("svg:circle").attr("class", "radar-chart-serie"+series)
                                  .attr('r', cfg.radius)
                                  .attr("alt", function(j){return Math.max(j.value, 0)})
                                  .attr("cx", function(j, i){
                                      if (j.value != 0) {
                                          dataValues.push([
                                              getHorizontalPosition(i, cfg.w/2, (parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor),
                                              getVerticalPosition(i, cfg.h/2, (parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor)
                                          ]);
                                          return getHorizontalPosition(i, cfg.w/2, (Math.max(j.value, 0)/cfg.maxValue)*cfg.factor);
                                      } else return -5;
                                   })
                                  .attr("cy", function(j, i){
                                      if (j.value != 0)
                                          return getVerticalPosition(i, cfg.h/2, (Math.max(j.value, 0)/cfg.maxValue)*cfg.factor);
                                       else return -5;
                                   })
            .attr("data-id", function(j){return j.axis})
            .style("fill", cfg.color(series)).style("fill-opacity", .9)
            .on('mouseover', function (d){
                newX = parseFloat(d3.select(this).attr('cx')) - 10;
                newY = parseFloat(d3.select(this).attr('cy')) - 5;
                tooltip.attr('x', newX).attr('y', newY).text(d.value).transition(200).style('opacity', 1);
                z = "polygon."+d3.select(this).attr("class");
                g.selectAll("polygon").transition(200).style("fill-opacity", 0.1);
                g.selectAll(z).transition(200).style("fill-opacity", .7);
             })
            .on('mouseout', function(){
                tooltip.transition(200).style('opacity', 0);
                g.selectAll("polygon").transition(200).style("fill-opacity", cfg.opacityArea);
             })
            .append("svg:title");
//            .text(function(j){return Math.max(j.value, 0)});

          series++;
        });

        //Tooltip
        tooltip = g.append('text').style('opacity', 0).style('font-family', 'sans-serif').style('font-size', '13px');
    }



</script>

</html>

